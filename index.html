<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HiQ Test Form</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(135deg, #0a0f1f, #1a2740);
  color: #fff;
  margin: 0;
  padding: 0;
}
.form-container {
  display: flex;
  align-items: flex-start;
  gap: 30px;
  max-width: 1200px;
  margin: 40px auto;
  padding: 0 20px;
}
.hiq-form {
  flex: 2;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 30px;
}
.section-block h3 {
  text-align: center;
  margin-bottom: 10px;
}
.checkout-box {
  flex: 1;
  position: sticky;
  top: 20px;
  background: rgba(255, 255, 255, 0.08);
  padding: 20px;
  border-radius: 12px;
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}
label {
  display: block;
  margin-top: 10px;
  font-weight: 500;
}
input, select {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: none;
  margin-top: 4px;
  margin-bottom: 10px;
  box-sizing: border-box;
}
.device-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  align-items: center;
}
.device-row select {
  flex: 1;
}
.device-row .custom-qty {
  width: 90px;
  display: none;
}
button {
  width: 100%;
  padding: 12px;
  border: none;
  background-color: #80e0ff;
  color: #0a0f1f;
  font-weight: 700;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}
button:hover {
  background-color: #00b3ff;
}
@media (max-width: 880px) {
  .form-container { flex-direction: column; padding: 16px; }
  .checkout-box { position: static; max-height: none; }
}
</style>
</head>
<body>

<div class="form-container">
  <div class="hiq-form">
    <h1 style="text-align:center; color:#80e0ff;">HiQ Test Form</h1>

    <form id="hiqForm">
      <label for="name">Name</label>
      <input type="text" id="name" name="name" required />

      <label for="email">Email</label>
      <input type="email" id="email" name="email" required />

      <label for="contact">Contact</label>
      <input type="text" id="contact" name="contact" placeholder="Optional" />

      <label for="package">Package</label>
      <select id="package" name="package">
        <option value="Essential">Essential</option>
      </select>

      <!-- HiQ Security Essentials -->
      <div class="section-block">
        <h3>HiQ Security Essentials</h3>
        <div class="device-row">
          <select id="securityEssential1"><option value="">Select Device</option></select>
          <select id="securityDesc1"><option value="">Select Description</option></select>
          <select id="securityQty1">
            <option value="">Qty</option><option>1</option><option>2</option>
            <option>3</option><option>4</option><option>5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="securityCustom1" type="number" min="1" placeholder="Qty">
        </div>

        <div class="device-row">
          <select id="securityEssential2"><option value="">Select Device</option></select>
          <select id="securityDesc2"><option value="">Select Description</option></select>
          <select id="securityQty2">
            <option value="">Qty</option><option>1</option><option>2</option>
            <option>3</option><option>4</option><option>5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="securityCustom2" type="number" min="1" placeholder="Qty">
        </div>
      </div>

      <!-- HiQ Power Control Essentials -->
      <div class="section-block">
        <h3>HiQ Power Control Essentials</h3>

        <div class="device-row">
          <select id="powerEssential1"><option value="">Select Device</option></select>
          <select id="powerDesc1"><option value="">Select Description</option></select>
          <select id="powerQty1">
            <option value="">Qty</option><option>1</option><option>2</option>
            <option>3</option><option>4</option><option>5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="powerCustom1" type="number" min="1" placeholder="Qty">
        </div>

        <div class="device-row">
          <select id="powerEssential2"><option value="">Select Device</option></select>
          <select id="powerDesc2"><option value="">Select Description</option></select>
          <select id="powerQty2">
            <option value="">Qty</option><option>1</option><option>2</option>
            <option>3</option><option>4</option><option>5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="powerCustom2" type="number" min="1" placeholder="Qty">
        </div>

        <div class="device-row">
          <select id="powerEssential3"><option value="">Select Device</option></select>
          <select id="powerDesc3"><option value="">Select Description</option></select>
          <select id="powerQty3">
            <option value="">Qty</option><option>1</option><option>2</option>
            <option>3</option><option>4</option><option>5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="powerCustom3" type="number" min="1" placeholder="Qty">
        </div>
      </div>

      <button type="submit" id="formSubmit" style="display:none;">Submit</button>
    </form>
  </div>

  <div class="checkout-box" id="quotePreview">
    <h3>Included in HiQ Essential</h3>
    <p>HiQ Central Hub</p>
    <p>Internet Router</p>
    <p>Echo Dot Voice Assistant</p>
    <p>HarmoniQ LIV App</p>
    <p>Trial Access to QARA (AI assistant)</p>
    <p>Installation – Free</p>

    <h3>Selected Devices</h3>
    <div id="liveSummary"><p>No devices selected</p></div>

    <h3>AI Result</h3>
    <div id="aiResult"></div>

    <button id="cartSubmitBtn">Submit</button>
  </div>
</div>

<script>
const catalogURL = "https://macapellan.app.n8n.cloud/webhook/hiq-catalog";
const submitURL  = "https://macapellan.app.n8n.cloud/webhook/ef1bcf20-e87f-4905-9921-968d45d4e639";

let devices = [];

const allDeviceSelects = [
  { deviceId: "securityEssential1", descId: "securityDesc1", qtyId: "securityQty1", customId: "securityCustom1", category: "Security" },
  { deviceId: "securityEssential2", descId: "securityDesc2", qtyId: "securityQty2", customId: "securityCustom2", category: "Security" },
  { deviceId: "powerEssential1", descId: "powerDesc1", qtyId: "powerQty1", customId: "powerCustom1", category: "Power Control" },
  { deviceId: "powerEssential2", descId: "powerDesc2", qtyId: "powerQty2", customId: "powerCustom2", category: "Power Control" },
  { deviceId: "powerEssential3", descId: "powerDesc3", qtyId: "powerQty3", customId: "powerCustom3", category: "Power Control" }
];

 async function loadDevices() {
  try {
    let res = await fetch(catalogURL, { method: "GET", mode: "cors", headers: { "Accept": "application/json" } });
    if (!res.ok) throw new Error(`Catalog fetch failed: ${res.status}`);
    const data = await res.json();

    // n8n might wrap rows inside { data: [...] }
    devices = Array.isArray(data) ? data : data.data || [];

    console.log("Loaded devices:", devices.length, devices);
    populateAllDevices();
  } catch (err) {
    console.error("Error loading catalog:", err);
    alert("Unable to load product catalog. Check console.");
  }
}

function populateAllDevices() {
  allDeviceSelects.forEach(sel => {
    const select = document.getElementById(sel.deviceId);
    select.innerHTML = `<option value="">Select Device</option>`;

    // Filter by "Banding" and "Subcategory 1 (FUNCTION)"
    const filtered = devices.filter(d => {
      const band = (d.Banding || "").toString();
      const cat = (d["Subcategory 1 (FUNCTION)"] || "").toString();
      return band.toLowerCase().includes("essential") &&
             cat.toLowerCase().includes(sel.category.toLowerCase());
    });

    // Use "Type" or "Name" as the visible generic group
    const uniqueGenerics = [...new Set(filtered.map(d => d.Type || d.Name || "").filter(Boolean))];
    uniqueGenerics.forEach(g => {
      const option = document.createElement("option");
      option.value = g;
      option.textContent = g;
      select.appendChild(option);
    });

    const descSelect = document.getElementById(sel.descId);
    if (descSelect) descSelect.innerHTML = `<option value="">Select Description</option>`;
  });

  updateSummary();
}

function populateDescription(deviceSelectId, descSelectId, category) {
  const deviceSelect = document.getElementById(deviceSelectId);
  const descSelect = document.getElementById(descSelectId);
  const selectedGeneric = deviceSelect.value;

  const matches = devices.filter(d => {
    const band = (d.Banding || "").toString();
    const cat = (d["Subcategory 1 (FUNCTION)"] || "").toString();
    const type = (d.Type || d.Name || "").toString();
    return band.toLowerCase().includes("essential") &&
           cat.toLowerCase().includes(category.toLowerCase()) &&
           type === selectedGeneric;
  });

  descSelect.innerHTML = `<option value="">Select Description</option>`;
  matches.forEach(m => {
    const deviceName = m.Description || m.Name || "";
    const sku = (m.SKU || "").toString();
    const option = document.createElement("option");
    option.value = JSON.stringify({ deviceName, sku });
    option.textContent = `${deviceName}${sku ? " — " + sku : ""}`;
    descSelect.appendChild(option);
  });
}

function updateSummary() {
  const summaryDiv = document.getElementById("liveSummary");
  let html = "";
  allDeviceSelects.forEach(sel => {
    const device = document.getElementById(sel.deviceId).value;
    const descVal = document.getElementById(sel.descId).value;
    const qtyVal = document.getElementById(sel.qtyId).value;
    const customEl = document.getElementById(sel.customId);
    let qtyFinal = qtyVal === "custom" ? customEl.value || "(custom)" : qtyVal;

    if (device || descVal || qtyVal) {
      let descText = "";
      let skuText = "";
      if (descVal) {
        try {
          const parsed = JSON.parse(descVal);
          descText = parsed.desc || "";
          skuText = parsed.sku ? ` | ${parsed.sku}` : "";
        } catch {}
      }
      html += `<p><strong>${device}</strong> — ${descText}${skuText} — Qty: ${qtyFinal}</p>`;
    }
  });
  summaryDiv.innerHTML = html || "<p>No devices selected</p>";
}

allDeviceSelects.forEach(sel => {
  const deviceEl = document.getElementById(sel.deviceId);
  const descEl = document.getElementById(sel.descId);
  const qtyEl = document.getElementById(sel.qtyId);
  const customEl = document.getElementById(sel.customId);

  deviceEl.addEventListener("change", () => {
    populateDescription(sel.deviceId, sel.descId, sel.category);
    updateSummary();
  });
  descEl.addEventListener("change", updateSummary);
  qtyEl.addEventListener("change", () => {
    customEl.style.display = qtyEl.value === "custom" ? "block" : "none";
    updateSummary();
  });
  customEl.addEventListener("input", updateSummary);
});

document.getElementById("cartSubmitBtn").addEventListener("click", submitForm);

async function submitForm() {
  const payload = {
    name: document.getElementById("name").value,
    email: document.getElementById("email").value,
    contact: document.getElementById("contact").value,
    package: document.getElementById("package").value,
    devices: allDeviceSelects.map(sel => {
      const device = document.getElementById(sel.deviceId).value;
      const descRaw = document.getElementById(sel.descId).value;
      let parsed = {};
      try { parsed = JSON.parse(descRaw); } catch {}
      const qty = document.getElementById(sel.qtyId).value;
      const custom = document.getElementById(sel.customId).value;
      return {
        category: sel.category,
        name: device,
        description: parsed.desc || "",
        sku: parsed.sku || "",
        quantity: qty === "custom" ? custom : qty
      };
    }).filter(d => d.name)
  };

  try {
    const res = await fetch(submitURL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    document.getElementById("aiResult").innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
    alert("Form submitted successfully!");
  } catch (err) {
    console.error("Error submitting form:", err);
    alert("Error submitting form. Check console for details.");
  }
}

loadDevices();
</script>
</body>
</html>

