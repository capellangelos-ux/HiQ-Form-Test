<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HiQ Test Form</title>
<style>
body {
  font-family: "Segoe UI", sans-serif;
  background: linear-gradient(135deg, #0a0f1f, #1a2740);
  color: #fff;
  margin: 0;
  padding: 0;
}

.form-container {
  display: flex;
  align-items: flex-start;
  gap: 30px;
  max-width: 1200px;
  margin: 40px auto;
  padding: 0 20px;
}

.hiq-form {
  flex: 2;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 30px;
}

.section-block h3 {
  text-align: center;
  margin-bottom: 10px;
}

.checkout-box {
  flex: 1;
  position: sticky;
  top: 20px;
  background: rgba(255, 255, 255, 0.08);
  padding: 20px;
  border-radius: 12px;
  max-height: calc(100vh - 40px);
  overflow-y: auto;
}

label {
  display: block;
  margin-top: 10px;
  font-weight: 500;
}

input, select {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: none;
  margin-top: 4px;
  margin-bottom: 10px;
  box-sizing: border-box;
}

.device-row {
  display: flex;
  gap: 10px;
  margin-bottom: 10px;
  align-items: center;
}

.device-row select {
  flex: 1;
}

.device-row .custom-qty {
  width: 90px;
  display: none;
}

button {
  width: 100%;
  padding: 12px;
  border: none;
  background-color: #80e0ff;
  color: #0a0f1f;
  font-weight: 700;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s;
}

button:hover {
  background-color: #00b3ff;
}

/* responsive */
@media (max-width: 880px) {
  .form-container { flex-direction: column; padding: 16px; }
  .checkout-box { position: static; max-height: none; }
}
</style>
</head>
<body>

<div class="form-container">
  <div class="hiq-form">
    <h1 style="text-align:center; color:#80e0ff;">HiQ Test Form</h1>

    <form id="hiqForm">
      <label for="name">Name</label>
      <input type="text" id="name" name="name" required />

      <label for="email">Email</label>
      <input type="email" id="email" name="email" required />

      <label for="contact">Contact</label>
      <input type="text" id="contact" name="contact" placeholder="Optional" />

      <label for="package">Package</label>
      <select id="package" name="package">
        <option value="Essential">Essential</option>
      </select>

      <div class="section-block">
        <h3>HiQ Security Essentials</h3>

        <div class="device-row">
          <select id="securityEssential1"><option value="">Select Device</option></select>
          <select id="securityDesc1"><option value="">Select Description</option></select>
          <select id="securityQty1">
            <option value="">Select Quantity</option>
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="securityCustom1" type="number" min="1" placeholder="Qty">
        </div>

        <div class="device-row">
          <select id="securityEssential2"><option value="">Select Device</option></select>
          <select id="securityDesc2"><option value="">Select Description</option></select>
          <select id="securityQty2">
            <option value="">Select Quantity</option>
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="securityCustom2" type="number" min="1" placeholder="Qty">
        </div>
      </div>

      <div class="section-block">
        <h3>HiQ Power Control Essentials</h3>

        <div class="device-row">
          <select id="powerEssential1"><option value="">Select Device</option></select>
          <select id="powerDesc1"><option value="">Select Description</option></select>
          <select id="powerQty1">
            <option value="">Select Quantity</option>
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="powerCustom1" type="number" min="1" placeholder="Qty">
        </div>

        <div class="device-row">
          <select id="powerEssential2"><option value="">Select Device</option></select>
          <select id="powerDesc2"><option value="">Select Description</option></select>
          <select id="powerQty2">
            <option value="">Select Quantity</option>
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="powerCustom2" type="number" min="1" placeholder="Qty">
        </div>

        <div class="device-row">
          <select id="powerEssential3"><option value="">Select Device</option></select>
          <select id="powerDesc3"><option value="">Select Description</option></select>
          <select id="powerQty3">
            <option value="">Select Quantity</option>
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="custom">Custom</option>
          </select>
          <input class="custom-qty" id="powerCustom3" type="number" min="1" placeholder="Qty">
        </div>
      </div>

      <!-- keep original submit in form for progressive enhancement but we'll also use cart submit -->
      <button type="submit" id="formSubmit" style="display:none;">Submit</button>
    </form>
  </div>

  <div class="checkout-box" id="quotePreview">
    <h3>Included in HiQ Essential</h3>
    <p>HiQ Central Hub</p>
    <p>Internet Router</p>
    <p>Echo Dot Voice Assistant</p>
    <p>HarmoniQ LIV App</p>
    <p>Trial Access to QARA (AI assistant)</p>
    <p>Installation – Free</p>

    <h3>Selected Devices</h3>
    <div id="liveSummary"><p>No devices selected</p></div>

    <h3>AI Result</h3>
    <div id="aiResult"></div>

    <button id="cartSubmitBtn">Submit</button>
  </div>
</div>

<script>
/* ====== CONFIG - your production endpoints ====== */
const catalogURL = "https://macapellan.app.n8n.cloud/webhook/hiq-catalog"; 
const submitURL  = "https://macapellan.app.n8n.cloud/webhook/ef1bcf20-e87f-4905-9921-968d45d4e639";

/* ====== internal state ====== */
let devices = [];

const allDeviceSelects = [
  { deviceId: "securityEssential1", descId: "securityDesc1", qtyId: "securityQty1", customId: "securityCustom1", category: "Security" },
  { deviceId: "securityEssential2", descId: "securityDesc2", qtyId: "securityQty2", customId: "securityCustom2", category: "Security" },
  { deviceId: "powerEssential1", descId: "powerDesc1", qtyId: "powerQty1", customId: "powerCustom1", category: "Power Control" },
  { deviceId: "powerEssential2", descId: "powerDesc2", qtyId: "powerQty2", customId: "powerCustom2", category: "Power Control" },
  { deviceId: "powerEssential3", descId: "powerDesc3", qtyId: "powerQty3", customId: "powerCustom3", category: "Power Control" }
];

/* ====== load catalog ====== */
async function loadDevices() {
  try {
    let res = await fetch(catalogURL, {
      method: "GET",
      mode: "cors",
      headers: { "Accept": "application/json" }
    });

    // if GET fails (n8n returns 404 or similar), try POST
    if (!res.ok) {
      console.warn("GET failed, retrying with POST...");
      res = await fetch(catalogURL, {
        method: "POST",
        mode: "cors",
        headers: { "Accept": "application/json" }
      });
    }

    if (!res.ok) throw new Error(`Catalog fetch failed: ${res.status}`);

    const text = await res.text();
    try {
      devices = JSON.parse(text);
    } catch {
      console.warn("Non-JSON response, wrapping into array");
      devices = Array.isArray(text) ? text : [];
    }

    populateAllDevices();
  } catch (err) {
    console.error("Error loading catalog:", err);
    alert("Unable to load product catalog. Check console.");
  }
}

function populateAllDevices() {
  allDeviceSelects.forEach(sel => {
    const select = document.getElementById(sel.deviceId);
    select.innerHTML = `<option value="">Select Device</option>`;

    const filtered = devices.filter(d => {
      const pkg = (d.Package || d.package || "").toString();
      const cat = (d["Subcategory 1 (FUNCTION)"] || d.category || d["Subcategory"] || "").toString();
      const generic = d["Generic Device Name"] || d.generic || d["Device Group"] || "";
      return pkg.toLowerCase().includes("essential") && cat.toLowerCase().includes(sel.category.toLowerCase());
    });

    const uniqueGenerics = [...new Set(filtered.map(d => (d["Generic Device Name"] || d.generic || d["Device Group"] || "").toString()).filter(Boolean))];
    uniqueGenerics.forEach(g => {
      const option = document.createElement("option");
      option.value = g;
      option.textContent = g;
      select.appendChild(option);
    });

    const descSelect = document.getElementById(sel.descId);
    if (descSelect) descSelect.innerHTML = `<option value="">Select Description</option>`;
  });

  updateSummary();
}

/* ====== cascading description ====== */
function populateDescription(deviceSelectId, descSelectId, category) {
  const deviceSelect = document.getElementById(deviceSelectId);
  const descSelect = document.getElementById(descSelectId);
  const selectedGeneric = deviceSelect.value;

  const matches = devices.filter(d => {
    const pkg = (d.Package || d.package || "").toString();
    const cat = (d["Subcategory 1 (FUNCTION)"] || d.category || "").toString();
    const gen = (d["Generic Device Name"] || d.generic || "").toString();
    return pkg.toLowerCase().includes("essential") &&
           cat.toLowerCase().includes(category.toLowerCase()) &&
           gen === selectedGeneric;
  });

  descSelect.innerHTML = `<option value="">Select Description</option>`;
  matches.forEach(m => {
    const deviceName = m["Device Name"] || m.deviceName || m["Description"] || m.description || "";
    const sku = (m.SKU || m.sku || m["Item Code"] || "").toString();
    const option = document.createElement("option");
    option.value = JSON.stringify({ deviceName, sku });
    option.textContent = `${deviceName}${sku ? " — " + sku : ""}`;
    descSelect.appendChild(option);
  });
}

/* ====== summary ====== */
function updateSummary() {
  const summaryDiv = document.getElementById("liveSummary");
  let html = "";
  allDeviceSelects.forEach(sel => {
    const device = document.getElementById(sel.deviceId).value;
    const descVal = document.getElementById(sel.descId).value;
    const qtyVal = document.getElementById(sel.qtyId).value;
    const customEl = document.getElementById(sel.customId);

    let qtyFinal = qtyVal;
    if (qtyVal === "custom") qtyFinal = customEl && customEl.value ? customEl.value : "(custom)";

    if (device || descVal || qtyVal) {
      let deviceLabel = device || "-";
      let descLabel = "-";
      let skuLabel = "";
      if (descVal) {
        try {
          const parsed = JSON.parse(descVal);
          descLabel = parsed.deviceName || descLabel;
          skuLabel = parsed.sku ? ` | ${parsed.sku}` : "";
        } catch {}
      }
      html += `<p><strong>${deviceLabel}</strong> — ${descLabel}${skuLabel} — Qty: ${qtyFinal}</p>`;
    }
  });
  summaryDiv.innerHTML = html || "<p>No devices selected</p>";
}

/* ====== wire events ====== */
allDeviceSelects.forEach(sel => {
  const deviceEl = document.getElementById(sel.deviceId);
  const descEl = document.getElementById(sel.descId);
  const qtyEl = document.getElementById(sel.qtyId);
  const customEl = document.getElementById(sel.customId);

  deviceEl.addEventListener("change", () => {
    populateDescription(sel.deviceId, sel.descId, sel.category);
    updateSummary();
  });
  descEl.addEventListener("change", updateSummary);
  qtyEl.addEventListener("change", () => {
    if (qtyEl.value === "custom") {
      customEl.style.display = "block";
      customEl.focus();
    } else {
      customEl.style.display = "none";
      customEl.value = "";
    }
    updateSummary();
  });
  customEl.addEventListener("input", updateSummary);
});

/* ====== submit handler ====== */
document.getElementById("hiqForm").addEventListener("submit", e => {
  e.preventDefault();
  submitForm();
});
document.getElementById("cartSubmitBtn").addEventListener("click", submitForm);

async function submitForm() {
  const payload = {
    name: document.getElementById("name").value,
    email: document.getElementById("email").value,
    contact: document.getElementById("contact").value,
    package: document.getElementById("package").value,
    devices: allDeviceSelects.map(sel => {
      const device = document.getElementById(sel.deviceId).value || "";
      const descRaw = document.getElementById(sel.descId).value || "";
      let parsed = { deviceName: "", sku: "" };
      if (descRaw) try { parsed = JSON.parse(descRaw); } catch {}
      const qtyVal = document.getElementById(sel.qtyId).value || "";
      const customEl = document.getElementById(sel.customId);
      const qtyFinal = qtyVal === "custom" ? (customEl.value || null) : qtyVal;
      return { category: sel.category, generic: device, ...parsed, quantity: qtyFinal };
    }).filter(d => d.generic || d.deviceName)
  };

  try {
    const btn = document.getElementById("cartSubmitBtn");
    btn.disabled = true; btn.textContent = "Submitting...";

    const res = await fetch(submitURL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    const data = (() => { try { return JSON.parse(text); } catch { return text; }})();
    if (!res.ok) throw new Error(data);

    document.getElementById("aiResult").innerHTML = `<pre>${typeof data === "string" ? data : JSON.stringify(data, null, 2)}</pre>`;
    alert("Form submitted successfully!");
  } catch (err) {
    console.error("Submission error:", err);
    alert("Error submitting form. Check console for details.");
  } finally {
    const btn = document.getElementById("cartSubmitBtn");
    btn.disabled = false; btn.textContent = "Submit";
  }
}

loadDevices();
</script>
  
</body>
</html>

